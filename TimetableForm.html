<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Create Timetable — Enhanced | Indigo School</title>
  <style>
    :root{
      --accent:#2f8f3c; --accent-2:#196b2a; --muted:#57785d;
      --bg:#f2fff7; --card:#ffffff; --border:#e4f2e6;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui, -apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,var(--bg),#ffffff);color:#0b3a1e;margin:0;padding:0}

    /* NAVBAR */
    .navbar{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 18px;background:#fff;border-bottom:1px solid #e6f0ea;
      position:sticky;top:0;z-index:120;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .brand .logo{
      width:40px;height:40px;border-radius:8px;
      background:linear-gradient(135deg,#3aa55a,#1f7a3b);
      display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;
    }
    .brand h1{font-size:16px;margin:0}
    .nav-right{display:flex;gap:12px;align-items:center}
    .nav-links{display:flex;gap:12px;align-items:center}
    .nav-links a, .nav-links button.link-btn{
      padding:8px 12px;border-radius:8px;text-decoration:none;color:#0b2a1a;background:transparent;border:0;cursor:pointer;
    }
    .nav-links a:hover{background:#eef7ee}

    /* DROPDOWN (class-based) */
    .dropdown{position:relative}
    .drop-toggle{
      display:flex;align-items:center;gap:6px;cursor:pointer;padding:8px 12px;border-radius:8px;background:transparent;border:0;
    }
    .drop-toggle:hover{background:#eef7ee}
    .caret{font-size:12px;color:#175a33}
    .drop-menu{
      position:absolute;top:calc(100% + 8px);left:0;min-width:220px;background:#fff;border-radius:8px;
      box-shadow:0 10px 30px rgba(6,30,15,.08);border:1px solid #e6f2ea;overflow:hidden;display:none;z-index:60;
    }
    .drop-menu.show{display:block}
    .drop-menu a{display:block;padding:10px 12px;text-decoration:none;color:#0b2a1a;border-bottom:1px solid #f0f6f3}
    .drop-menu a:last-child{border-bottom:0}
    .drop-menu a:hover{background:#f6fff5}

    .btn{
      background:linear-gradient(180deg,var(--accent),var(--accent-2));
      color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;
    }

    .hamburger{display:none;background:transparent;border:0;font-size:20px}
    @media (max-width:820px){
      .nav-links{
        display:none;position:absolute;right:12px;top:56px;
        flex-direction:column;background:#fff;padding:12px;border-radius:8px;
        box-shadow:0 6px 18px rgba(6,30,15,.06);min-width:240px;
      }
      .hamburger{display:block}
      .nav-links.show{display:flex}
      .drop-menu{position:static;box-shadow:none;border:0;padding:0;background:transparent}
      .drop-menu a{background:#fff;border-radius:8px;margin-bottom:6px;border-bottom:0}
    }

    /* TIMETABLE PAGE STYLES (original) */
    .container{max-width:920px;margin:40px auto;padding:22px}
    .card{background:var(--card);border-radius:14px;padding:20px;border:1px solid var(--border);box-shadow:0 12px 30px rgba(12,60,30,0.04);margin-bottom:18px}
    h1{color:var(--accent);margin:0 0 6px}
    p.lead{color:var(--muted);margin:0 0 12px}
    label{display:block;font-weight:700;color:#174f2b;margin-bottom:6px}
    input,select,textarea{width:100%;padding:11px 12px;border-radius:10px;border:1.5px solid #dcefe0;background:#fbfffc;font-size:15px;transition:all .18s;outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(47,143,60,.12)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .controls{display:flex;gap:10px;align-items:center;margin:8px 0 16px}
    .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn-primary{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff}
    .btn-ghost{background:#fff;border:1.5px solid #d6eede;color:var(--accent)}
    .hint{font-size:13px;color:#6d8c75}
    .period{border-radius:12px;padding:12px;background:linear-gradient(180deg,#fbfff9,#ffffff);border:1px solid #eaf6ee;box-shadow:0 6px 18px rgba(12,60,30,.03);margin-bottom:12px}
    .period .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .period .head .title{font-weight:800;color:#154f2f}
    .period small{color:#6b8b74}
    .period .body{display:flex;flex-direction:column;gap:10px}
    .small{font-size:13px;color:#55775a}
    .subjects-line{display:flex;gap:8px}
    .subjects-line input{flex:1}
    .sub-row{display:flex;gap:8px;align-items:center}
    .sub-row select{flex:1}
    .sub-row input.override{flex:1}
    .actions{display:flex;gap:8px;align-items:center}
    .preview{padding:10px;border-radius:10px;border:1px dashed #dbeedf;background:#fbfff7;color:#235c3a;margin-top:10px;white-space:pre-wrap}
    @media(max-width:720px){.row{flex-direction:column}.subjects-line{flex-direction:column}}
  </style>
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar" role="navigation" aria-label="Main navigation">
    <div class="brand">
      <div class="logo">S</div>
      <div>
        <h1> School</h1>
        <div style="font-size:12px;color:#55775a">Admin dashboard</div>
      </div>
    </div>

    <div class="nav-right">
      <button class="hamburger" id="hamburger" aria-label="menu">☰</button>

      <div class="nav-links" id="navLinks">
        <!-- Students dropdown -->
          <a class="link-btn" href="home.html">Home</a>
        <div class="dropdown">
          <button class="drop-toggle" aria-haspopup="true" aria-expanded="false">
            Students <span class="caret">▾</span>
          </button>
          <div class="drop-menu" role="menu">
            <a href="StudentReg.html">Student Registration</a>
            <a href="attendance.html">Attendance</a>
             
          </div>
        </div>

        <!-- Faculty dropdown -->
        <div class="dropdown">
          <button class="drop-toggle" aria-haspopup="true" aria-expanded="false">
            Faculty <span class="caret">▾</span>
          </button>
          <div class="drop-menu" role="menu">
            <a href="faculty.html">Faculty Registration</a>
            <a href="leave.html">Leave Apply</a>
            <a href="leaveView.html">Leave View</a>
          </div>
        </div>

        <!-- Timetable dropdown -->
        <div class="dropdown">
          <button class="drop-toggle" aria-haspopup="true" aria-expanded="false">
            Time Table <span class="caret">▾</span>
          </button>
          <div class="drop-menu" role="menu">
            <a href="TimetableForm.html">Add Time Table</a>
            <a href="timetableview.html">Timetable View</a>
          </div>
        </div>

       
        <button class="btn" onclick="location.href='index.html'">Logout</button>
      </div>
    </div>
  </nav>

  <!-- TIMETABLE UI -->
  <div class="container">
    <div class="card">
      <h1>Create / Edit Timetable (Enhanced)</h1>
      <p class="lead">Set number of periods, provide subjects pool, set times, then fill each period's subjects quickly.</p>

      <div style="display:grid;gap:12px;">
        <div>
          <label for="classSelect">Class *</label>
          <select id="classSelect">
            <option value="">-- Select class --</option>
            <option value="8">Class 8</option>
            <option value="9">Class 9</option>
            <option value="10">Class 10</option>
            <option value="11">Class 11</option>
          </select>
        </div>

        <div class="row">
          <div style="flex:1">
            <label for="numPeriods">Number of periods (per day)</label>
            <input id="numPeriods" type="number" min="1" max="12" value="4" />
          </div>
          <div style="flex:1">
            <label for="defaultTimeLength">Default period length (minutes)</label>
            <input id="defaultTimeLength" type="number" min="20" max="120" value="45" />
          </div>
        </div>

        <div>
          <label for="subjectPool">Subjects (comma separated)</label>
          <div class="subjects-line">
            <input id="subjectPool" placeholder="e.g., Math, English, Physics, Chemistry, Biology, Computer" />
            <button id="applyPool" class="btn btn-ghost">Apply</button>
          </div>
          <div class="small">Use this pool to populate subject dropdowns for each period. You can still override per cell.</div>
        </div>

        <div class="controls">
          <button id="generatePeriods" class="btn btn-primary">Generate Periods</button>
          <button id="autoTimes" class="btn btn-ghost">Auto-generate Times</button>
          <button id="autoFill" class="btn btn-ghost">Auto-fill Subjects</button>
          <div class="hint">Generate periods → optionally auto-generate times → auto-fill subjects.</div>
        </div>

        <div id="periodsContainer" aria-live="polite"></div>

        <div>
          <label for="notes">Notes (optional)</label>
          <textarea id="notes" placeholder="Notes for this timetable (e.g., semester, special schedule)"></textarea>
        </div>

        <div class="row" style="justify-content:space-between;align-items:center">
          <div style="flex:1">
            <div class="preview" id="preview">No class selected.</div>
          </div>
          <div style="display:flex;gap:8px">
            <button id="loadBtn" class="btn btn-ghost">Load Existing</button>
            <button id="saveBtn" class="btn btn-primary">Save Timetable</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  /* NAVBAR INTERACTIONS (hamburger + multiple dropdowns) */
  const hamburger = document.getElementById('hamburger');
  const navLinks = document.getElementById('navLinks');
  hamburger?.addEventListener('click', () => navLinks.classList.toggle('show'));

  document.querySelectorAll('.dropdown').forEach(drop => {
    const toggle = drop.querySelector('.drop-toggle');
    const menu = drop.querySelector('.drop-menu');
    let hideTimer = null;

    // desktop hover open
    drop.addEventListener('mouseenter', () => {
      if (window.innerWidth > 820) {
        clearTimeout(hideTimer);
        menu.classList.add('show');
        toggle.setAttribute('aria-expanded', 'true');
      }
    });
    // desktop delayed close
    drop.addEventListener('mouseleave', () => {
      if (window.innerWidth > 820) {
        hideTimer = setTimeout(() => {
          menu.classList.remove('show');
          toggle.setAttribute('aria-expanded', 'false');
        }, 180);
      }
    });

    // click toggles (mobile + desktop)
    toggle.addEventListener('click', (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      clearTimeout(hideTimer);
      const opened = menu.classList.toggle('show');
      toggle.setAttribute('aria-expanded', opened ? 'true' : 'false');
    });

    // close when clicking outside
    document.addEventListener('click', (e) => {
      if (!drop.contains(e.target)) {
        menu.classList.remove('show');
        toggle.setAttribute('aria-expanded', 'false');
      }
    });

    // close on link click and collapse mobile nav
    menu.querySelectorAll('a').forEach(a => {
      a.addEventListener('click', () => {
        if (window.innerWidth <= 820) navLinks.classList.remove('show');
        menu.classList.remove('show');
      });
    });
  });

  /* TIMETABLE SCRIPT (unchanged, original logic) */
  const STORAGE_KEY = 'timetableData';

  // DOM
  const classSelect = document.getElementById('classSelect');
  const numPeriods = document.getElementById('numPeriods');
  const periodsContainer = document.getElementById('periodsContainer');
  const subjectPoolInput = document.getElementById('subjectPool');
  const applyPoolBtn = document.getElementById('applyPool');
  const generateBtn = document.getElementById('generatePeriods');
  const autoTimesBtn = document.getElementById('autoTimes');
  const autoFillBtn = document.getElementById('autoFill');
  const defaultTimeLength = document.getElementById('defaultTimeLength');
  const preview = document.getElementById('preview');
  const notes = document.getElementById('notes');
  const saveBtn = document.getElementById('saveBtn');
  const loadBtn = document.getElementById('loadBtn');

  function readStorage(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch(e) { return {}; } }
  function writeStorage(v){ localStorage.setItem(STORAGE_KEY, JSON.stringify(v)); }

  function getPool(){
    const raw = subjectPoolInput.value || '';
    return raw.split(',').map(s => s.trim()).filter(Boolean);
  }

  // generate period cards
  function generatePeriods(n, preserveExisting=false){
    if(preserveExisting){
      const existing = periodsContainer.querySelectorAll('.period');
      if(existing.length === n) return;
    }
    periodsContainer.innerHTML = '';
    const pool = getPool();
    for(let i=0;i<n;i++){
      const div = document.createElement('div');
      div.className = 'period';
      div.dataset.idx = i;
      div.innerHTML = `
        <div class="head">
          <div class="title">Period ${i+1}</div>
          <div class="small">Period #${i+1}</div>
        </div>
        <div class="body">
          <div>
            <label>Time</label>
            <input type="text" class="p-time" placeholder="e.g. 08:30 - 09:15" />
          </div>

          <div>
            <label>Monday (select or override)</label>
            <div class="sub-row">
              <select class="p-mon"></select>
              <input type="text" class="override p-mon-ovr" placeholder="override subject (optional)" />
            </div>
          </div>

          <div>
            <label>Tuesday</label>
            <div class="sub-row">
              <select class="p-tue"></select>
              <input type="text" class="override p-tue-ovr" placeholder="override subject (optional)" />
            </div>
          </div>

          <div>
            <label>Wednesday</label>
            <div class="sub-row">
              <select class="p-wed"></select>
              <input type="text" class="override p-wed-ovr" placeholder="override subject (optional)" />
            </div>
          </div>

          <div>
            <label>Thursday</label>
            <div class="sub-row">
              <select class="p-thu"></select>
              <input type="text" class="override p-thu-ovr" placeholder="override subject (optional)" />
            </div>
          </div>

          <div>
            <label>Friday</label>
            <div class="sub-row">
              <select class="p-fri"></select>
              <input type="text" class="override p-fri-ovr" placeholder="override subject (optional)" />
            </div>
          </div>
        </div>
      `;
      periodsContainer.appendChild(div);
      populateSelectsFor(div);
    }
    updatePreview();
  }

  function populateSelectsFor(periodEl){
    const pool = getPool();
    const selects = periodEl.querySelectorAll('select');
    selects.forEach(sel => {
      const current = sel.value;
      sel.innerHTML = '<option value="">-- select subject --</option>';
      pool.forEach(sub => {
        const opt = document.createElement('option');
        opt.value = sub;
        opt.textContent = sub;
        sel.appendChild(opt);
      });
      if(current) sel.value = current;
    });
  }

  // apply pool to existing selects
  applyPoolBtn.addEventListener('click', (e) => {
    e.preventDefault();
    periodsContainer.querySelectorAll('.period').forEach(p => populateSelectsFor(p));
    updatePreview();
  });

  generateBtn.addEventListener('click', () => {
    const n = parseInt(numPeriods.value) || 0;
    if(n <= 0){ alert('Please enter a valid number of periods'); return; }
    generatePeriods(n);
  });

  // AUTO-GENERATE times
  autoTimesBtn.addEventListener('click', () => {
    const len = parseInt(defaultTimeLength.value) || 45;
    const gap = 5;
    const startH = 8, startM = 30;
    const periods = periodsContainer.querySelectorAll('.period');
    let cur = new Date();
    cur.setHours(startH); cur.setMinutes(startM); cur.setSeconds(0); cur.setMilliseconds(0);
    periods.forEach(p => {
      const start = formatTime(cur);
      cur.setMinutes(cur.getMinutes() + len);
      const end = formatTime(cur);
      p.querySelector('.p-time').value = `${start} - ${end}`;
      cur.setMinutes(cur.getMinutes() + gap);
    });
    updatePreview();
  });

  function formatTime(d){
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    return `${hh}:${mm}`;
  }

  // AUTO-FILL subjects
  autoFillBtn.addEventListener('click', () => {
    const pool = getPool();
    if(pool.length === 0){ alert('Subject pool empty — please add subjects first.'); return; }
    const periods = periodsContainer.querySelectorAll('.period');
    let idx = 0;
    periods.forEach(p => {
      ['mon','tue','wed','thu','fri'].forEach(day => {
        const sel = p.querySelector(`.p-${day}`);
        const ovr = p.querySelector(`.p-${day}-ovr`);
        if((!sel.value || sel.value === '') && (!ovr.value || ovr.value.trim() === '')){
          sel.value = pool[idx % pool.length];
          idx++;
        }
      });
    });
    updatePreview();
  });

  // SAVE timetable
  saveBtn.addEventListener('click', () => {
    const classKey = classSelect.value;
    if(!classKey){ alert('Select a class first.'); return; }
    const pool = getPool();
    const periods = [];
    periodsContainer.querySelectorAll('.period').forEach(p => {
      const time = p.querySelector('.p-time').value.trim();
      const row = { time };
      ['mon','tue','wed','thu','fri'].forEach(day => {
        const sel = p.querySelector(`.p-${day}`).value.trim();
        const ovr = p.querySelector(`.p-${day}-ovr`).value.trim();
        row[day] = ovr || sel || '';
      });
      periods.push(row);
    });
    const store = readStorage();
    store[classKey] = { subjects: pool, notes: notes.value.trim(), periods };
    writeStorage(store);
    alert('Timetable saved for class ' + classKey);
    updatePreview();
  });

  // LOAD existing or generate based on number
  loadBtn.addEventListener('click', () => {
    loadForSelectedClass();
  });

  function loadForSelectedClass(){
    const classKey = classSelect.value;
    if(!classKey){ alert('Select a class first'); return; }
    const store = readStorage();
    const data = store[classKey];
    if(!data){
      const n = parseInt(numPeriods.value) || 0;
      if(n <= 0) { alert('No timetable saved and number of periods not set.'); return; }
      generatePeriods(n);
      preview.textContent = `Class ${classKey} — editing ${n} periods (no saved timetable).`;
      return;
    }
    subjectPoolInput.value = (data.subjects || []).join(', ');
    notes.value = data.notes || '';
    const n = (data.periods || []).length || parseInt(numPeriods.value) || 0;
    numPeriods.value = n;
    generatePeriods(n);
    const periods = periodsContainer.querySelectorAll('.period');
    periods.forEach((p, idx) => {
      const src = (data.periods[idx] || {});
      p.querySelector('.p-time').value = src.time || '';
      ['mon','tue','wed','thu','fri'].forEach(day => {
        const sel = p.querySelector(`.p-${day}`);
        const ovr = p.querySelector(`.p-${day}-ovr`);
        if(src[day]){
          const found = Array.from(sel.options).some(opt => opt.value === src[day]);
          if(found) sel.value = src[day];
          else { sel.value=''; ovr.value = src[day]; }
        }
      });
    });
    updatePreview();
  }

  // preview update
  function updatePreview(){
    const classKey = classSelect.value || '(no class)';
    const pool = getPool();
    const periods = [];
    periodsContainer.querySelectorAll('.period').forEach((p, idx) => {
      const time = p.querySelector('.p-time').value.trim() || `Period ${idx+1}`;
      const mon = p.querySelector('.p-mon-ovr').value.trim() || p.querySelector('.p-mon').value || '';
      const tue = p.querySelector('.p-tue-ovr').value.trim() || p.querySelector('.p-tue').value || '';
      const wed = p.querySelector('.p-wed-ovr').value.trim() || p.querySelector('.p-wed').value || '';
      const thu = p.querySelector('.p-thu-ovr').value.trim() || p.querySelector('.p-thu').value || '';
      const fri = p.querySelector('.p-fri-ovr').value.trim() || p.querySelector('.p-fri').value || '';
      periods.push(`${time} | Mon:${mon || '—'} Tue:${tue || '—'} Wed:${wed || '—'} Thu:${thu || '—'} Fri:${fri || '—'}`);
    });
    const txt = `Class: ${classKey}\nSubjects pool: ${pool.join(', ') || '—'}\nPeriods: ${periods.length}\n\n` + (periods.length? periods.join('\n') : 'No periods generated') + (notes.value ? `\n\nNotes: ${notes.value}` : '');
    preview.textContent = txt;
  }

  document.addEventListener('input', (e) => {
    if(e.target.matches('.p-time') || e.target.matches('select') || e.target.matches('.override') || e.target === subjectPoolInput || e.target === notes || e.target === numPeriods){
      updatePreview();
    }
  });

  // --- NEW: auto-generate when user changes numPeriods immediately ---
  numPeriods.addEventListener('change', (e) => {
    const n = parseInt(e.target.value) || 0;
    if(n <= 0) return;
    generatePeriods(n);
  });

  // --- NEW: when class changes, auto-load if saved, otherwise generate current number of periods ---
  classSelect.addEventListener('change', () => {
    const classKey = classSelect.value;
    if(!classKey){
      preview.textContent = 'No class selected.';
      return;
    }
    const store = readStorage();
    if(store[classKey]) {
      loadForSelectedClass();
    } else {
      const n = parseInt(numPeriods.value) || 0;
      if(n > 0) generatePeriods(n);
      updatePreview();
    }
  });

  // initialize
  (function init(){
    generatePeriods(parseInt(numPeriods.value));
    updatePreview();
  })();

  // expose helper
  window.timetable_creator = { getStorage: readStorage };
</script>
</body>
</html>
